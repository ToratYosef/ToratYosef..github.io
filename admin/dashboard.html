<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Referrer Dashboard - Yeshivat Torat Yosef Raffle</title>
  <link rel="favicon-32x32" href="favicon/favicon.ico">
  <meta name="theme-color" content="#ffffff" />
  <style>
    /* Reusing your existing CSS for consistency */
    :root {
      --primary-bg: #ffffff;
      --primary-text: rgb(0, 33, 65);
      --secondary-bg: rgb(0, 33, 65);
      --accent: #7F0031;
      --hover: #590023;
      --button-gradient-start: #a30040;
      --button-gradient-end: #7F0031;
    }

    body {
      margin: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: var(--primary-bg);
      color: var(--primary-text);
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      padding-bottom: 2rem; /* More space at bottom */
    }

    .logo-container {
      text-align: center;
      padding: 0.8rem 0 0.4rem;
      flex-shrink: 0;
    }

    .logo {
      max-width: 250px;
      width: 80vw;
      height: auto;
      border: 1px solid rgba(0, 0, 0, 0.1);
      border-radius: 8px;
      box-sizing: border-box;
    }

    .container {
      max-width: 800px; /* Wider for dashboard */
      margin: 2rem auto;
      padding: 30px;
      background-color: #f8f8f8;
      border-radius: 10px;
      box-shadow: 0 0 15px rgba(0,0,0,0.2);
      text-align: center;
      flex-grow: 1;
      width: 90%;
      box-sizing: border-box;
      position: relative; /* For loading overlay */
    }

    h1 {
      color: var(--accent);
      margin-bottom: 25px;
      font-size: 1.8rem;
    }

    .dashboard-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      flex-wrap: wrap; /* Allow wrap on small screens */
      gap: 15px; /* Space between elements */
    }

    .welcome-message {
      font-size: 1.5em;
      color: var(--primary-text);
      font-weight: bold;
      flex-grow: 1; /* Allows it to take available space */
      text-align: left;
    }

    .logout-button {
      padding: 8px 15px;
      background-color: #dc3545; /* Red for logout */
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 0.9em;
      transition: background-color 0.3s ease;
    }

    .logout-button:hover {
      background-color: #c82333;
    }

    .section-title {
        color: var(--secondary-bg);
        font-size: 1.4em;
        margin-top: 30px;
        margin-bottom: 15px;
        border-bottom: 2px solid rgba(0,0,0,0.1);
        padding-bottom: 10px;
        text-align: left;
    }

    .referral-link-section {
        background-color: #e6f7ff;
        border: 1px solid #cceeff;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 25px;
        text-align: left;
    }

    .referral-link-section p {
        margin-bottom: 10px;
        font-size: 1.1em;
        color: var(--primary-text);
    }

    .referral-link-input-group {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        align-items: center; /* Align items vertically */
    }

    #referral-link-display {
        flex-grow: 1;
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 5px;
        font-size: 0.95em;
        background-color: #ffffff;
        color: var(--primary-text);
        overflow-x: auto; /* Allow horizontal scrolling for long links */
        white-space: nowrap; /* Keep link on one line */
        box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
    }

    .copy-button, .qr-button {
        padding: 10px 15px;
        background-color: var(--secondary-bg);
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 0.95em;
        transition: background-color 0.3s ease;
        white-space: nowrap;
    }

    .copy-button:hover, .qr-button:hover {
        background-color: var(--accent);
    }

    .progress-section {
        margin-top: 30px;
        margin-bottom: 30px;
        text-align: left;
    }

    .progress-bar-container {
        width: 100%;
        background-color: #e0e0e0;
        border-radius: 10px;
        overflow: hidden;
        margin-top: 10px;
        height: 25px;
        box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
    }

    .progress-bar {
        height: 100%;
        width: 0%; /* Will be set by JS */
        background: linear-gradient(to right, #28a745, #218838); /* Green gradient */
        border-radius: 10px;
        text-align: center;
        color: white;
        font-weight: bold;
        line-height: 25px;
        transition: width 0.5s ease-in-out;
        white-space: nowrap;
        overflow: hidden;
    }

    .progress-text {
        font-size: 1.1em;
        margin-bottom: 8px;
        color: var(--primary-text);
    }

    .buyers-table-container {
      margin-top: 30px;
      overflow-x: auto; /* Allows horizontal scrolling on small screens */
    }

    .buyers-table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
      font-size: 0.9em;
      text-align: left;
    }

    .buyers-table th, .buyers-table td {
      border: 1px solid #ddd;
      padding: 10px;
    }

    .buyers-table th {
      background-color: var(--secondary-bg);
      color: white;
      font-weight: bold;
      white-space: nowrap;
    }

    .buyers-table tr:nth-child(even) {
      background-color: #f2f2f2;
    }

    .buyers-table tr:hover {
      background-color: #e9e9e9;
    }

    .loading-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(255, 255, 255, 0.8);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 10;
      border-radius: 10px;
      font-size: 1.2em;
      color: var(--primary-text);
      transition: opacity 0.3s ease;
    }

    .loading-overlay.hidden {
      opacity: 0;
      pointer-events: none;
    }

    .hidden { /* For hiding elements like buyer table or whole sections */
        display: none !important;
    }

    .empty-state {
        text-align: center;
        margin-top: 30px;
        color: #666;
        font-size: 1.1em;
        padding: 20px;
        border: 1px dashed #ccc;
        border-radius: 8px;
    }

    .footer {
      width: 100%;
      background-color: var(--secondary-bg);
      color: white;
      text-align: center;
      padding: 1.5rem 1rem;
      font-size: 0.9em;
      margin-top: auto; /* Pushes footer to the bottom */
      flex-shrink: 0;
    }

    .footer a {
        color: var(--accent);
        text-decoration: none;
        font-weight: bold;
    }

    .footer a:hover {
        text-decoration: underline;
    }

    /* QR Code Modal Styles */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.7);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s ease, visibility 0.3s ease;
    }

    .modal-overlay.visible {
        opacity: 1;
        visibility: visible;
    }

    .modal-content {
        background-color: #fff;
        padding: 25px;
        border-radius: 10px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        text-align: center;
        max-width: 90%;
        width: 350px;
        position: relative;
    }

    .modal-close-button {
        position: absolute;
        top: 10px;
        right: 15px;
        font-size: 1.5em;
        cursor: pointer;
        background: none;
        border: none;
        color: #333;
    }

    #qrcode-canvas {
        margin: 20px auto;
        display: block; /* Center the canvas */
        max-width: 100%;
        height: auto;
    }

    .modal-buttons {
        display: flex;
        flex-direction: column;
        gap: 10px;
        margin-top: 20px;
    }

    .modal-buttons button {
        padding: 10px 20px;
        border-radius: 5px;
        border: none;
        cursor: pointer;
        font-size: 1em;
        font-weight: bold;
        transition: background-color 0.3s ease;
    }

    .modal-buttons .share-button {
        background-color: #007bff;
        color: white;
    }
    .modal-buttons .share-button:hover {
        background-color: #0056b3;
    }

    .modal-buttons .download-button {
        background-color: #6c757d;
        color: white;
    }
    .modal-buttons .download-button:hover {
        background-color: #5a6268;
    }


    @media (max-width: 600px) {
      .container {
        padding: 15px;
        margin: 1rem auto;
      }

      h1 {
        font-size: 1.6rem;
      }

      .logo {
        max-width: 200px;
      }

      .welcome-message {
        font-size: 1.2em;
      }

      .section-title {
        font-size: 1.2em;
      }
    }
  </style>
</head>
<body>
  <div class="logo-container">
    <img class="logo" src="/logo.png" alt="Yeshivat Torat Yosef Logo" />
  </div>

  <div class="container">
    <div id="loading-overlay" class="loading-overlay">
      Loading Dashboard...
    </div>

    <div class="dashboard-header">
      <h1 class="welcome-message" id="welcome-message">Welcome!</h1>
      <button id="logout-button" class="logout-button">Log Out</button>
    </div>

    <!-- Referral link section: Always visible for referrers -->
    <div class="referral-link-section" id="referral-link-section">
      <p>Your unique referral link:</p>
      <div class="referral-link-input-group">
        <span id="referral-link-display">Loading...</span>
        <button id="copy-link-button" class="copy-button">Copy Link</button>
        <button id="generate-qr-button" class="qr-button">Generate QR Code</button>
      </div>
    </div>

    <div class="progress-section">
        <h2 class="section-title">Ticket Sales Progress</h2>
        <p class="progress-text">
            <span id="tickets-sold">0</span> tickets sold out of <span id="goal-tickets">0</span> goal.
        </p>
        <div class="progress-bar-container">
            <div class="progress-bar" id="progress-bar">
                <span id="progress-percentage">0%</span>
            </div>
        </div>
    </div>

    <!-- Buyer details section: Always visible for referrers -->
    <div id="buyers-details-master-container">
        <h2 class="section-title">Buyer Details</h2>
        <div id="buyers-details-container" class="buyers-table-container">
          <p id="empty-buyers-state" class="empty-state hidden">No tickets sold through your link yet.</p>
          <table class="buyers-table" id="buyers-table">
            <thead>
              <tr>
                <th>Name</th>
                <th>Email</th>
                <th>Phone</th>
                <th>Tickets</th>
                <th>Time</th>
              </tr>
            </thead>
            <tbody id="buyers-table-body">
              <!-- Buyer details will be populated here by JavaScript -->
            </tbody>
          </table>
        </div>
    </div>

    <!-- Removed: All Referrers Summary Section -->

  </div>

  <footer class="footer">
    Website made by Saul Setton<br />
    <a href="tel:9295845753">929-584-5753</a> | 
    <a href="mailto:saulsetton16@gmail.com">saulsetton16@gmail.com</a>
  </footer>

  <!-- QR Code Modal -->
  <div id="qr-code-modal" class="modal-overlay">
      <div class="modal-content">
          <button class="modal-close-button" id="close-qr-modal">&times;</button>
          <h3>Your Referral QR Code</h3>
          <canvas id="qrcode-canvas" width="200" height="200"></canvas>
          <div class="modal-buttons">
              <button class="share-button" id="share-qr-button">Share QR Code</button>
              <button class="download-button" id="download-qr-button">Download QR Code</button>
          </div>
      </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-functions-compat.js"></script>
  <!-- QR Code Library -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>

  <script>
    // Initialize Firebase with your provided configuration
    const firebaseConfig = {
      apiKey: "AIzaSyDfXnCZXN-URjdvFvVlWHLg4KOkSw7hvng",
      authDomain: "torat-yosef.firebaseapp.com",
      projectId: "torat-yosef",
      storageBucket: "torat-yosef.firebasestorage.app",
      messagingSenderId: "1033400220494",
      appId: "1:1033400220494:web:1437414bdad4439fd6bc1f",
      measurementId: "G-331D9RHZWH"
    };
    firebase.initializeApp(firebaseConfig);

    const auth = firebase.auth();
    const functions = firebase.functions();
    const getReferrerDashboardData = functions.httpsCallable('getReferrerDashboardData');

    // DOM elements
    const loadingOverlay = document.getElementById('loading-overlay');
    const welcomeMessageElement = document.getElementById('welcome-message');
    const logoutButton = document.getElementById('logout-button');
    const referralLinkSection = document.getElementById('referral-link-section'); 
    const referralLinkDisplay = document.getElementById('referral-link-display');
    const copyLinkButton = document.getElementById('copy-link-button');
    const generateQrButton = document.getElementById('generate-qr-button'); // New QR button
    const ticketsSoldElement = document.getElementById('tickets-sold');
    const goalTicketsElement = document.getElementById('goal-tickets');
    const progressBar = document.getElementById('progress-bar');
    const progressPercentage = document.getElementById('progress-percentage');
    const buyersDetailsMasterContainer = document.getElementById('buyers-details-master-container'); 
    const buyersTableBody = document.getElementById('buyers-table-body');
    const emptyBuyersState = document.getElementById('empty-buyers-state');
    const buyersTable = document.getElementById('buyers-table');

    // QR Code Modal elements
    const qrCodeModal = document.getElementById('qr-code-modal');
    const closeQrModalButton = document.getElementById('close-qr-modal');
    const qrcodeCanvas = document.getElementById('qrcode-canvas');
    const shareQrButton = document.getElementById('share-qr-button');
    const downloadQrButton = document.getElementById('download-qr-button');
    let qrCodeDataUrl = ''; // To store the generated QR code data URL


    // Function to show/hide loading overlay
    function showLoading() {
      loadingOverlay.classList.remove('hidden');
    }

    function hideLoading() {
      loadingOverlay.classList.add('hidden');
    }

    // Redirect to login if not authenticated
    auth.onAuthStateChanged(user => {
      if (!user) {
        window.location.href = './login.html'; // Relative path
      } else {
        fetchDashboardData(); // Fetch data once user is confirmed logged in
      }
    });

    // Function to set default/blank values if data is missing or error
    function setDefaultDashboardData() {
        welcomeMessageElement.textContent = `Welcome! (Your Dashboard)`;
        referralLinkDisplay.textContent = 'N/A';
        ticketsSoldElement.textContent = '0';
        goalTicketsElement.textContent = '0';
        progressBar.style.width = '0%';
        progressPercentage.textContent = '0%';
        buyersTableBody.innerHTML = '';
        emptyBuyersState.classList.remove('hidden');
        buyersTable.style.display = 'none';

        // Optionally disable buttons if critical data (like referral link) is missing
        generateQrButton.disabled = true;
        copyLinkButton.disabled = true;
    }

    // Fetch dashboard data
    async function fetchDashboardData() {
      showLoading();
      try {
        const result = await getReferrerDashboardData();
        const data = result.data;

        // Populate fields with data from the function
        welcomeMessageElement.textContent = `Welcome, ${data.name}! (Your Dashboard)`; 
        referralLinkDisplay.textContent = data.referralLink || 'N/A'; // Handle null referralLink
        ticketsSoldElement.textContent = data.totalTicketsSold;
        goalTicketsElement.textContent = data.goal;
        
        const progress = data.goal > 0 ? (data.totalTicketsSold / data.goal) * 100 : 0;
        progressBar.style.width = `${Math.min(progress, 100)}%`; 
        progressPercentage.textContent = `${Math.round(progress)}%`;

        // Ensure buttons are enabled if link is valid
        if (data.referralLink && data.referralLink !== 'N/A') {
            generateQrButton.disabled = false;
            copyLinkButton.disabled = false;
        } else {
            generateQrButton.disabled = true;
            copyLinkButton.disabled = true;
        }

        // Populate buyer details table (FIXED LOGIC HERE)
        buyersTableBody.innerHTML = ''; // Clear existing rows
        if (data.buyerDetails && data.buyerDetails.length > 0) {
          emptyBuyersState.classList.add('hidden');
          buyersTable.style.display = 'table'; 
          data.buyerDetails.forEach(buyer => {
            const row = buyersTableBody.insertRow(); // Create a new row
            row.insertCell().textContent = buyer.name;
            row.insertCell().textContent = buyer.email;
            row.insertCell().textContent = buyer.phone;
            row.insertCell().textContent = buyer.ticketsBought;
            row.insertCell().textContent = buyer.timestamp;
          });
        } else {
          emptyBuyersState.classList.remove('hidden');
          buyersTable.style.display = 'none'; 
        }

      } catch (error) {
        console.error('Error fetching dashboard data:', error);
        // Do NOT show alert or redirect. Instead, set default values.
        setDefaultDashboardData();
      } finally {
        hideLoading();
      }
    }

    // Logout functionality
    logoutButton.addEventListener('click', async () => {
      try {
        await auth.signOut();
        window.location.href = './login.html'; // Relative path
      } catch (error) {
        console.error('Logout error:', error);
        alert('Failed to log out. Please try again.');
      }
    });

    // Copy referral link to clipboard
    copyLinkButton.addEventListener('click', () => {
      const linkToCopy = referralLinkDisplay.textContent;
      if (linkToCopy === 'N/A' || linkToCopy === 'Loading...') {
          alert('No referral link available to copy.');
          return;
      }
      // Using navigator.clipboard for modern browsers
      navigator.clipboard.writeText(linkToCopy).then(() => {
        alert('Referral link copied to clipboard!');
      }).catch(err => {
        console.error('Failed to copy text: ', err);
        // Fallback for older browsers or if permission is denied
        // document.execCommand('copy') is deprecated, but might be needed for older iframe environments
        const tempInput = document.createElement('textarea');
        tempInput.value = linkToCopy;
        document.body.appendChild(tempInput);
        tempInput.select();
        try {
            document.execCommand('copy');
            alert('Referral link copied to clipboard (fallback method)!');
        } catch (err) {
            console.error('Fallback copy failed:', err);
            alert('Failed to copy link. Please copy it manually: ' + linkToCopy);
        } finally {
            document.body.removeChild(tempInput);
        }
      });
    });

    // --- QR Code Generation and Sharing Logic ---
    generateQrButton.addEventListener('click', () => {
        const link = referralLinkDisplay.textContent;
        if (!link || link === 'N/A' || link === 'Loading...') {
            alert('No referral link available to generate QR code.');
            return;
        }

        // Clear previous QR code
        qrcodeCanvas.getContext('2d').clearRect(0, 0, qrcodeCanvas.width, qrcodeCanvas.height);

        // Generate QR code on canvas
        const qr = new QRious({
            element: qrcodeCanvas,
            value: link,
            size: 200, // Fixed size for QR code in modal
            level: 'H', // High error correction
        });
        
        qrCodeDataUrl = qrcodeCanvas.toDataURL(); // Store data URL for sharing/download

        qrCodeModal.classList.add('visible'); // Show the modal
    });

    closeQrModalButton.addEventListener('click', () => {
        qrCodeModal.classList.remove('visible'); // Hide the modal
    });

    qrCodeModal.addEventListener('click', (event) => {
        // Close modal if clicking outside the content
        if (event.target === qrCodeModal) {
            qrCodeModal.classList.remove('visible');
        }
    });

    shareQrButton.addEventListener('click', async () => {
        if (!qrCodeDataUrl) {
            alert('QR Code not generated yet.');
            return;
        }

        // Convert Data URL to Blob for sharing
        const blob = await (await fetch(qrCodeDataUrl)).blob();
        const file = new File([blob], 'referral_qr_code.png', { type: 'image/png' });

        if (navigator.canShare && navigator.canShare({ files: [file] })) {
            try {
                await navigator.share({
                    files: [file],
                    title: 'My Raffle Referral QR Code',
                    text: 'Scan this QR code to purchase raffle tickets through my link and support our cause!',
                });
                console.log('QR Code shared successfully!');
            } catch (error) {
                console.error('Error sharing QR Code:', error);
                // User cancelled or another error
                if (error.name !== 'AbortError') { // Don't alert if user just closed share dialog
                    alert('Failed to share QR code. ' + (error.message || 'Please try again.'));
                }
            }
        } else {
            // Fallback for browsers that don't support Web Share API for files
            alert('Web Share API for files is not supported in this browser. Please use the "Download" button to save the image and share it manually.');
            // Optionally, automatically trigger download as a fallback
            // downloadQrButton.click(); // This would cause an automatic download on incompatible browsers
        }
    });

    downloadQrButton.addEventListener('click', () => {
        if (!qrCodeDataUrl) {
            alert('QR Code not generated yet.');
            return;
        }
        const a = document.createElement('a');
        a.href = qrCodeDataUrl;
        a.download = 'referral_qr_code.png';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        // No alert needed here as download is a direct action.
    });
    // --- End QR Code Generation and Sharing Logic ---
  </script>
</body>
</html>