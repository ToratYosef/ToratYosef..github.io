<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Referrer Dashboard - Yeshivat Torat Yosef Raffle</title>
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-icon-180x180.png" />
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
  <meta name="theme-color" content="#ffffff" />
  <style>
    /* Reusing your existing CSS for consistency */
    :root {
      --primary-bg: #ffffff;
      --primary-text: rgb(0, 33, 65);
      --secondary-bg: rgb(0, 33, 65);
      --accent: #7F0031;
      --hover: #590023;
      --button-gradient-start: #a30040;
      --button-gradient-end: #7F0031;
    }

    body {
      margin: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: var(--primary-bg);
      color: var(--primary-text);
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      padding-bottom: 2rem; /* More space at bottom */
    }

    .logo-container {
      text-align: center;
      padding: 0.8rem 0 0.4rem;
      flex-shrink: 0;
    }

    .logo {
      max-width: 250px;
      width: 80vw;
      height: auto;
      border: 1px solid rgba(0, 0, 0, 0.1);
      border-radius: 8px;
      box-sizing: border-box;
    }

    .container {
      max-width: 800px; /* Wider for dashboard */
      margin: 2rem auto;
      padding: 30px;
      background-color: #f8f8f8;
      border-radius: 10px;
      box-shadow: 0 0 15px rgba(0,0,0,0.2);
      text-align: center;
      flex-grow: 1;
      width: 90%;
      box-sizing: border-box;
      position: relative; /* For loading overlay */
    }

    h1 {
      color: var(--accent);
      margin-bottom: 25px;
      font-size: 1.8rem;
    }

    .dashboard-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      flex-wrap: wrap; /* Allow wrap on small screens */
      gap: 15px; /* Space between elements */
    }

    .welcome-message {
      font-size: 1.5em;
      color: var(--primary-text);
      font-weight: bold;
      flex-grow: 1; /* Allows it to take available space */
      text-align: left;
    }

    .logout-button {
      padding: 8px 15px;
      background-color: #dc3545; /* Red for logout */
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 0.9em;
      transition: background-color 0.3s ease;
    }

    .logout-button:hover {
      background-color: #c82333;
    }

    .section-title {
        color: var(--secondary-bg);
        font-size: 1.4em;
        margin-top: 30px;
        margin-bottom: 15px;
        border-bottom: 2px solid rgba(0,0,0,0.1);
        padding-bottom: 10px;
        text-align: left;
    }

    .referral-link-section {
        background-color: #e6f7ff;
        border: 1px solid #cceeff;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 25px;
        text-align: left;
    }

    .referral-link-section p {
        margin-bottom: 10px;
        font-size: 1.1em;
        color: var(--primary-text);
    }

    .referral-link-input-group {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
    }

    #referral-link-display {
        flex-grow: 1;
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 5px;
        font-size: 0.95em;
        background-color: #ffffff;
        color: var(--primary-text);
        overflow-x: auto; /* Allow horizontal scrolling for long links */
        white-space: nowrap; /* Keep link on one line */
        box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
    }

    .copy-button {
        padding: 10px 15px;
        background-color: var(--secondary-bg);
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 0.95em;
        transition: background-color 0.3s ease;
        white-space: nowrap;
    }

    .copy-button:hover {
        background-color: var(--accent);
    }

    .progress-section {
        margin-top: 30px;
        margin-bottom: 30px;
        text-align: left;
    }

    .progress-bar-container {
        width: 100%;
        background-color: #e0e0e0;
        border-radius: 10px;
        overflow: hidden;
        margin-top: 10px;
        height: 25px;
        box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
    }

    .progress-bar {
        height: 100%;
        width: 0%; /* Will be set by JS */
        background: linear-gradient(to right, #28a745, #218838); /* Green gradient */
        border-radius: 10px;
        text-align: center;
        color: white;
        font-weight: bold;
        line-height: 25px;
        transition: width 0.5s ease-in-out;
        white-space: nowrap;
        overflow: hidden;
    }

    .progress-text {
        font-size: 1.1em;
        margin-bottom: 8px;
        color: var(--primary-text);
    }

    .buyers-table-container {
      margin-top: 30px;
      overflow-x: auto; /* Allows horizontal scrolling on small screens */
    }

    .buyers-table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
      font-size: 0.9em;
      text-align: left;
    }

    .buyers-table th, .buyers-table td {
      border: 1px solid #ddd;
      padding: 10px;
    }

    .buyers-table th {
      background-color: var(--secondary-bg);
      color: white;
      font-weight: bold;
      white-space: nowrap;
    }

    .buyers-table tr:nth-child(even) {
      background-color: #f2f2f2;
    }

    .buyers-table tr:hover {
      background-color: #e9e9e9;
    }

    .loading-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(255, 255, 255, 0.8);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 10;
      border-radius: 10px;
      font-size: 1.2em;
      color: var(--primary-text);
      transition: opacity 0.3s ease;
    }

    .loading-overlay.hidden {
      opacity: 0;
      pointer-events: none;
    }

    .hidden { /* For hiding elements like buyer table or whole sections */
        display: none !important;
    }

    .empty-state {
        text-align: center;
        margin-top: 30px;
        color: #666;
        font-size: 1.1em;
        padding: 20px;
        border: 1px dashed #ccc;
        border-radius: 8px;
    }

    @media (max-width: 768px) {
        .dashboard-header {
            flex-direction: column;
            align-items: flex-start;
        }
        .welcome-message {
            text-align: center;
            width: 100%;
            margin-bottom: 10px;
        }
        .logout-button {
            width: 100%;
        }
        .referral-link-input-group {
            flex-direction: column;
        }
        .copy-button {
            width: 100%;
        }
    }

    @media (max-width: 600px) {
      .container {
        padding: 15px;
        margin: 1rem auto;
      }

      h1 {
        font-size: 1.6rem;
      }

      .logo {
        max-width: 200px;
      }

      .welcome-message {
        font-size: 1.2em;
      }

      .section-title {
        font-size: 1.2em;
      }
    }
  </style>
</head>
<body>
  <div class="logo-container">
    <img class="logo" src="assets/logo.png" alt="Yeshivat Torat Yosef Logo" />
  </div>

  <div class="container">
    <div id="loading-overlay" class="loading-overlay">
      Loading Dashboard...
    </div>

    <div class="dashboard-header">
      <h1 class="welcome-message" id="welcome-message">Welcome!</h1>
      <button id="logout-button" class="logout-button">Log Out</button>
    </div>

    <!-- Referral link section: Hide for viewers as they don't have their own link -->
    <div class="referral-link-section" id="referral-link-section">
      <p>Your unique referral link:</p>
      <div class="referral-link-input-group">
        <span id="referral-link-display">Loading...</span>
        <button id="copy-link-button" class="copy-button">Copy Link</button>
      </div>
    </div>

    <div class="progress-section">
        <h2 class="section-title">Ticket Sales Progress</h2>
        <p class="progress-text">
            <span id="tickets-sold">0</span> tickets sold out of <span id="goal-tickets">0</span> goal.
        </p>
        <div class="progress-bar-container">
            <div class="progress-bar" id="progress-bar">
                <span id="progress-percentage">0%</span>
            </div>
        </div>
    </div>

    <!-- Buyer details section: Hide for viewers -->
    <div id="buyers-details-master-container">
        <h2 class="section-title">Buyer Details</h2>
        <div id="buyers-details-container" class="buyers-table-container">
          <p id="empty-buyers-state" class="empty-state hidden">No tickets sold through your link yet.</p>
          <table class="buyers-table" id="buyers-table">
            <thead>
              <tr>
                <th>Name</th>
                <th>Email</th>
                <th>Phone</th>
                <th>Tickets</th>
                <th>Time</th>
              </tr>
            </thead>
            <tbody id="buyers-table-body">
              <!-- Buyer details will be populated here by JavaScript -->
            </tbody>
          </table>
        </div>
    </div>

    <!-- NEW: All Referrers Summary Section (hidden by default) -->
    <div id="all-referrers-summary-container" class="hidden">
        <h2 class="section-title">All Referrers Summary</h2>
        <div class="summary-table-container">
            <p id="empty-summary-state" class="empty-state hidden">No referrer data available.</p>
            <table class="buyers-table" id="summary-table">
                <thead>
                    <tr>
                        <th>Referrer Name</th>
                        <th>Ref ID</th>
                        <th>Goal</th>
                        <th>Tickets Sold</th>
                        <th>Tickets Left</th>
                    </tr>
                </thead>
                <tbody id="summary-table-body">
                    <!-- Summary data will be populated here by JavaScript -->
                </tbody>
            </table>
        </div>
    </div>

  </div>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-functions-compat.js"></script>
  <script>
    // Initialize Firebase with your provided configuration
    const firebaseConfig = {
      apiKey: "AIzaSyDfXnCZXN-URjdvFvVlWHLg4KOkSw7hvng",
      authDomain: "torat-yosef.firebaseapp.com",
      projectId: "torat-yosef",
      storageBucket: "torat-yosef.firebasestorage.app",
      messagingSenderId: "1033400220494",
      appId: "1:1033400220494:web:1437414bdad4439fd6bc1f",
      measurementId: "G-331D9RHZWH"
    };
    firebase.initializeApp(firebaseConfig);

    const auth = firebase.auth();
    const functions = firebase.functions();
    const getReferrerDashboardData = functions.httpsCallable('getReferrerDashboardData');

    // DOM elements
    const loadingOverlay = document.getElementById('loading-overlay');
    const welcomeMessageElement = document.getElementById('welcome-message');
    const logoutButton = document.getElementById('logout-button');
    const referralLinkSection = document.getElementById('referral-link-section'); 
    const referralLinkDisplay = document.getElementById('referral-link-display');
    const copyLinkButton = document.getElementById('copy-link-button');
    const ticketsSoldElement = document.getElementById('tickets-sold');
    const goalTicketsElement = document.getElementById('goal-tickets');
    const progressBar = document.getElementById('progress-bar');
    const progressPercentage = document.getElementById('progress-percentage');
    const buyersDetailsMasterContainer = document.getElementById('buyers-details-master-container'); 
    const buyersTableBody = document.getElementById('buyers-table-body');
    const emptyBuyersState = document.getElementById('empty-buyers-state');
    const buyersTable = document.getElementById('buyers-table');

    // NEW Summary elements
    const allReferrersSummaryContainer = document.getElementById('all-referrers-summary-container');
    const summaryTableBody = document.getElementById('summary-table-body');
    const emptySummaryState = document.getElementById('empty-summary-state');
    const summaryTable = document.getElementById('summary-table');


    // Function to show/hide loading overlay
    function showLoading() {
      loadingOverlay.classList.remove('hidden');
    }

    function hideLoading() {
      loadingOverlay.classList.add('hidden');
    }

    // Redirect to login if not authenticated
    auth.onAuthStateChanged(user => {
      if (!user) {
        window.location.href = '/login.html';
      } else {
        fetchDashboardData(); // Fetch data once user is confirmed logged in
      }
    });

    // Fetch dashboard data
    async function fetchDashboardData() {
      showLoading();
      try {
        const result = await getReferrerDashboardData();
        const data = result.data;

        // Dynamic welcome message
        welcomeMessageElement.textContent = `Welcome, ${data.name}! (${data.dashboardTitleName} Dashboard)`;

        // Update personal progress section
        ticketsSoldElement.textContent = data.totalTicketsSold;
        goalTicketsElement.textContent = data.goal;
        const progress = data.goal > 0 ? (data.totalTicketsSold / data.goal) * 100 : 0;
        progressBar.style.width = `${Math.min(progress, 100)}%`; 
        progressPercentage.textContent = `${Math.round(progress)}%`;

        // Handle visibility of referrer-specific elements vs. viewer/superAdminReferrer
        if (data.isViewer) {
            referralLinkSection.classList.add('hidden'); // Standard viewers don't have their own link
            buyersDetailsMasterContainer.classList.add('hidden'); // Hide buyer details for standard viewers
            allReferrersSummaryContainer.classList.add('hidden'); // Standard viewers don't see all summary either
        } else if (data.isSuperAdminReferrer) {
            // Super Admin Referrers see their own link and details, AND the summary
            referralLinkSection.classList.remove('hidden');
            buyersDetailsMasterContainer.classList.remove('hidden');
            allReferrersSummaryContainer.classList.remove('hidden'); // Show all referrers summary

            referralLinkDisplay.textContent = data.referralLink; // Their own referral link

            // Populate their own buyer details table (since they are also referrers)
            buyersTableBody.innerHTML = ''; 
            if (data.buyerDetails && data.buyerDetails.length > 0) {
              emptyBuyersState.classList.add('hidden');
              buyersTable.style.display = 'table'; 
              data.buyerDetails.forEach(buyer => {
                const row = buyersTableBody.insertRow();
                row.insertCell().textContent = buyer.name;
                row.insertCell().textContent = buyer.email;
                row.insertCell().textContent = buyer.phone;
                row.insertCell().textContent = buyer.ticketsBought;
                row.insertCell().textContent = buyer.timestamp;
              });
            } else {
              emptyBuyersState.classList.remove('hidden');
              buyersTable.style.display = 'none'; 
            }

            // Populate All Referrers Summary Table
            summaryTableBody.innerHTML = '';
            if (data.allReferrersSummary && data.allReferrersSummary.length > 0) {
                emptySummaryState.classList.add('hidden');
                summaryTable.style.display = 'table';
                data.allReferrersSummary.forEach(referrer => {
                    const row = summaryTableBody.insertRow();
                    row.insertCell().textContent = referrer.name;
                    row.insertCell().textContent = referrer.refId;
                    row.insertCell().textContent = referrer.goal;
                    row.insertCell().textContent = referrer.totalTicketsSold;
                    row.insertCell().textContent = referrer.ticketsRemaining;
                });
            } else {
                emptySummaryState.classList.remove('hidden');
                summaryTable.style.display = 'none';
            }

        } else { // Regular referrer (not viewer, not super admin)
            referralLinkSection.classList.remove('hidden');
            buyersDetailsMasterContainer.classList.remove('hidden');
            allReferrersSummaryContainer.classList.add('hidden'); // Regular referrers don't see all summary

            referralLinkDisplay.textContent = data.referralLink;

            // Populate buyer details table
            buyersTableBody.innerHTML = ''; 
            if (data.buyerDetails && data.buyerDetails.length > 0) {
              emptyBuyersState.classList.add('hidden');
              buyersTable.style.display = 'table'; 
              data.buyerDetails.forEach(buyer => {
                const row = buyersTableBody.insertRow();
                row.insertCell().textContent = buyer.name;
                row.insertCell().textContent = buyer.email;
                row.insertCell().textContent = buyer.phone;
                row.insertCell().textContent = buyer.ticketsBought;
                row.insertCell().textContent = buyer.timestamp;
              });
            } else {
              emptyBuyersState.classList.remove('hidden');
              buyersTable.style.display = 'none'; 
            }
        }

      } catch (error) {
        console.error('Error fetching dashboard data:', error);
        alert(`Failed to load dashboard data: ${error.message}`);
        // Optionally, redirect to login on data fetch error
        auth.signOut().then(() => {
          window.location.href = '/login.html';
        });
      } finally {
        hideLoading();
      }
    }

    // Logout functionality
    logoutButton.addEventListener('click', async () => {
      try {
        await auth.signOut();
        window.location.href = '/login.html'; // Redirect to login page
      } catch (error) {
        console.error('Logout error:', error);
        alert('Failed to log out. Please try again.');
      }
    });

    // Copy referral link to clipboard
    copyLinkButton.addEventListener('click', () => {
      const linkToCopy = referralLinkDisplay.textContent;
      document.execCommand('copy'); // Using deprecated but widely supported method for iFrame compatibility
      navigator.clipboard.writeText(linkToCopy).then(() => { // Modern API fallback/alternative
        alert('Referral link copied to clipboard!');
      }).catch(err => {
        console.error('Failed to copy text: ', err);
        alert('Failed to copy link. Please copy it manually: ' + linkToCopy);
      });
    });
  </script>
</body>
</html>